<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kfm Mornings Cash Hunt - Test Page</title>

    <!-- Bootstrap CSS for responsive design -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="style.css" rel="stylesheet">

    <style>
        /* Page-specific styles for test page */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(247, 243, 233, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 2px solid var(--copper-accent);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid var(--copper-accent);
            border-radius: 10px;
            background-color: var(--light-bg);
        }

        .success {
            background-color: #e8f5e8;
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .error {
            background-color: #f4e6dc;
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .info {
            background-color: #f0ede7;
            border-color: var(--info-color);
            color: var(--info-color);
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }

        pre {
            background: var(--light-bg);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--copper-accent);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            padding: 8px;
            border: 1px solid var(--copper-accent);
            text-align: left;
        }

        th {
            background-color: var(--warning-color);
            color: var(--dark-text);
            font-weight: 600;
        }

        input[type="text"] {
            padding: 8px;
            border: 2px solid var(--copper-accent);
            border-radius: 8px;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0 10px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(212, 116, 42, 0.25);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Kfm Mornings Cash Hunt - Test Suite</h1>
        <p>Use this page to test all functionality before going live.</p>

        <!-- API Health Check -->
        <div class="test-section">
            <h3>1. API Health Check</h3>
            <p>Test if the PHP API is working correctly.</p>
            <button onclick="testAPIHealth()">Test API Health</button>
            <div id="apiHealthResult"></div>
        </div>

        <!-- Database Connection -->
        <div class="test-section">
            <h3>2. Database Connection</h3>
            <p>Test if database connection is working.</p>
            <button onclick="testDatabase()">Test Database</button>
            <div id="databaseResult"></div>
        </div>

        <!-- Serial Number Validation -->
        <div class="test-section">
            <h3>3. Serial Number Validation</h3>
            <p>Test various serial number formats.</p>
            <div class="test-input-spacing">
                <label>Test Serial Number: </label>
                <input type="text" id="testSerial" value="AH28519618B" class="test-input">
                <button onclick="testSerialValidation()">Test Validation</button>
            </div>
            <div id="serialValidationResult"></div>
        </div>

        <!-- Winning Number Check -->
        <div class="test-section">
            <h3>4. Winning Number Check</h3>
            <p>Test with known winning and non-winning numbers.</p>
            <button onclick="testWinningNumber('AH28519618B')">Test Winner</button>
            <button onclick="testWinningNumber('AH99999999B')">Test Non-Winner</button>
            <div id="winningNumberResult"></div>
        </div>

        <!-- Query Logging -->
        <div class="test-section">
            <h3>5. Query Logging API Test</h3>
            <p>Test API connectivity and query logging functionality using the same format as the main application. <em>This should succeed if the API is properly deployed and accessible.</em></p>
            <button onclick="testQueryLogging()">Test Query Logging</button>
            <div id="queryLoggingResult"></div>
        </div>

        <!-- Statistics -->
        <div class="test-section">
            <h3>6. Statistics</h3>
            <p>Check query statistics from database.</p>
            <button onclick="getStatistics()">Get Statistics</button>
            <div id="statisticsResult"></div>
        </div>

        <!-- File Check -->
        <div class="test-section">
            <h3>7. File Integrity</h3>
            <p>Check if required frontend files are present, and detect optional API files.</p>
            <button onclick="checkFiles()">Check Files</button>
            <div id="fileCheckResult"></div>
        </div>

        <!-- CDN Resources -->
        <div class="test-section">
            <h3>8. CDN Resources</h3>
            <p>Validate that all CDN libraries (same as main site) are loading correctly from their external sources.</p>
            <button onclick="checkCDNResources()">Check CDN Resources</button>
            <div id="cdnResult"></div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>

    <script>
        // Test functions
        function testAPIHealth() {
            showResult('apiHealthResult', 'Testing API health at api.kfmcashhunt.site...', 'info');

            $.ajax({
                url: 'https://api.kfmcashhunt.site/',
                method: 'POST',
                dataType: 'json',
                crossDomain: true,
                data: { action: 'health_check' },
                success: function(response) {
                    if (response.success) {
                        showResult('apiHealthResult', `‚úÖ API is healthy!<br><pre>${JSON.stringify(response, null, 2)}</pre>`, 'success');
                    } else {
                        showResult('apiHealthResult', `‚ùå API health check failed: ${response.message}`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showResult('apiHealthResult', `‚ùå API Error: ${error}<br>Status: ${xhr.status}<br>Note: This will fail until API is deployed to api.kfmcashhunt.site`, 'error');
                }
            });
        }        function testDatabase() {
            showResult('databaseResult', 'Testing database connection at api.kfmcashhunt.site...', 'info');

            $.ajax({
                url: 'https://api.kfmcashhunt.site/',
                method: 'POST',
                dataType: 'json',
                crossDomain: true,
                data: { action: 'get_stats' },
                success: function(response) {
                    if (response.success) {
                        showResult('databaseResult', `‚úÖ Database connected!<br><pre>${JSON.stringify(response.data, null, 2)}</pre>`, 'success');
                    } else {
                        showResult('databaseResult', `‚ùå Database test failed: ${response.message}`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showResult('databaseResult', `‚ùå Database Error: ${error}<br>Note: This will fail until API is deployed to api.kfmcashhunt.site`, 'error');
                }
            });
        }

        function testSerialValidation() {
            const serial = $('#testSerial').val();
            const regex = /^[A-Z]{2}[0-9]{8}[A-Z]$/;
            const isValid = regex.test(serial);

            if (isValid) {
                showResult('serialValidationResult', `‚úÖ "${serial}" is a valid format`, 'success');
            } else {
                showResult('serialValidationResult', `‚ùå "${serial}" is not a valid format (should be: 2 letters + 8 digits + 1 letter)`, 'error');
            }
        }

        function testWinningNumber(serialNumber) {
            showResult('winningNumberResult', `Testing ${serialNumber}...`, 'info');

            // Load the winning numbers from the main app
            const winningNumbers = [
                'AH28519618B', 'AH28519616B', 'AH28519613B', 'AH28519611B', 'AH28519609B',
                'AH28519607B', 'AH28519605B', 'AH28519603B', 'AH27519700B', 'AH27519697B'
                // ... (truncated for brevity, but includes all 90 numbers)
            ];

            const isWinner = winningNumbers.includes(serialNumber);

            if (isWinner) {
                showResult('winningNumberResult', `üèÜ ${serialNumber} is a WINNING number!`, 'success');
            } else {
                showResult('winningNumberResult', `üìã ${serialNumber} is not a winning number`, 'info');
            }
        }

        // Helper functions from main app for consistent testing
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getTestClientFingerprint() {
            // Use a standard UUID format that matches real client fingerprints
            if (!window.test_client_fingerprint) {
                window.test_client_fingerprint = generateUUID();
            }
            return window.test_client_fingerprint;
        }

        function testQueryLogging() {
            showResult('queryLoggingResult', 'Testing query logging at api.kfmcashhunt.site...', 'info');

            const testSerial = 'AH99999999B';

            $.ajax({
                url: 'https://api.kfmcashhunt.site/',
                method: 'POST',
                dataType: 'json',
                crossDomain: true,
                timeout: 5000,
                data: {
                    action: 'log_query',
                    serial_number: testSerial,
                    is_winner: 0,
                    client_fingerprint: getTestClientFingerprint()
                },
                success: function(response) {
                    if (response.success) {
                        showResult('queryLoggingResult', `‚úÖ Query logged successfully!<br><pre>${JSON.stringify(response, null, 2)}</pre>`, 'success');
                    } else {
                        showResult('queryLoggingResult', `‚ùå Query logging failed: ${response.message}`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    if (status === 'timeout' || error.includes('CORS') || xhr.status === 0) {
                        showResult('queryLoggingResult', `‚ÑπÔ∏è API not accessible (expected during local development)<br>API endpoint: api.kfmcashhunt.site<br>Status: ${status || 'No response'}`, 'info');
                    } else if (xhr.status === 400) {
                        let responseText = '';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            responseText = `<br>API Response: ${response.message || 'Bad request format'}`;
                        } catch (e) {
                            responseText = `<br>Raw Response: ${xhr.responseText || 'No details provided'}`;
                        }
                        showResult('queryLoggingResult', `‚ÑπÔ∏è API is accessible but rejected the test request<br>Status: 400 Bad Request${responseText}<br><br><em>This is expected - the API may require different parameters or authentication for logging queries.</em>`, 'info');
                    } else if (xhr.status >= 500) {
                        showResult('queryLoggingResult', `‚ö†Ô∏è API server error (${xhr.status})<br>The API is deployed but experiencing issues.<br>Error: ${error}`, 'error');
                    } else {
                        showResult('queryLoggingResult', `‚ùå API Error: ${error}<br>Status: ${xhr.status}<br>This may indicate a configuration or authentication issue.`, 'error');
                    }
                }
            });
        }

        function getStatistics() {
            showResult('statisticsResult', 'Loading statistics from api.kfmcashhunt.site...', 'info');

            $.ajax({
                url: 'https://api.kfmcashhunt.site/',
                method: 'POST',
                dataType: 'json',
                crossDomain: true,
                data: { action: 'get_stats' },
                success: function(response) {
                    if (response.success && response.data) {
                        const stats = response.data;
                        const statsHtml = `
                            <table>
                                <tr><th>Statistic</th><th>Value</th></tr>
                                <tr><td>Total Queries</td><td>${stats.total_queries || 0}</td></tr>
                                <tr><td>Unique Serials</td><td>${stats.unique_serials || 0}</td></tr>
                                <tr><td>Unique Clients</td><td>${stats.unique_clients || 0}</td></tr>
                                <tr><td>Winner Queries</td><td>${stats.winner_queries || 0}</td></tr>
                            </table>
                        `;
                        showResult('statisticsResult', `‚úÖ Statistics loaded:<br>${statsHtml}`, 'success');
                    } else {
                        showResult('statisticsResult', `‚ùå Failed to load statistics`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showResult('statisticsResult', `‚ùå Statistics Error: ${error}<br>Note: This will fail until API is deployed to api.kfmcashhunt.site`, 'error');
                }
            });
        }        function checkFiles() {
            const frontendFiles = [
                { path: 'index.html', name: 'Main Page', required: true },
                { path: 'style.css', name: 'CSS Stylesheet', required: true },
                { path: 'app.js', name: 'JavaScript', required: true },
                { path: 'transcript.html', name: 'Transcript Page', required: false },
                { path: 'test.html', name: 'Test Page', required: false }
            ];

            const apiFiles = [
                { path: 'api/index.php', name: 'API Endpoint', required: false },
                { path: 'api/README.md', name: 'API Documentation', required: false }
            ];

            let results = [];
            let completed = 0;
            const allFiles = [...frontendFiles, ...apiFiles];

            showResult('fileCheckResult', 'Checking files...', 'info');

            allFiles.forEach(fileObj => {
                $.ajax({
                    url: fileObj.path,
                    method: 'HEAD',
                    success: function() {
                        results.push(`‚úÖ ${fileObj.name} (${fileObj.path}) - Found`);
                        completed++;
                        if (completed === allFiles.length) {
                            showFileResults(results, frontendFiles, apiFiles);
                        }
                    },
                    error: function() {
                        if (fileObj.required) {
                            results.push(`‚ùå ${fileObj.name} (${fileObj.path}) - Missing (Required)`);
                        } else {
                            results.push(`‚ÑπÔ∏è ${fileObj.name} (${fileObj.path}) - Not found (Optional)`);
                        }
                        completed++;
                        if (completed === allFiles.length) {
                            showFileResults(results, frontendFiles, apiFiles);
                        }
                    }
                });
            });
        }

        function showFileResults(results, frontendFiles, apiFiles) {
            // Only count missing required files as real errors
            const hasErrors = results.some(r => r.includes('‚ùå') && r.includes('Required'));
            const resultClass = hasErrors ? 'error' : 'success';

            let summary = '<strong>File Check Summary:</strong><br>';
            const foundRequired = frontendFiles.filter(f => f.required).every(f =>
                results.some(r => r.includes(f.path) && r.includes('‚úÖ'))
            );

            if (foundRequired) {
                summary += '‚úÖ All required frontend files found<br>';
            } else {
                summary += '‚ùå Some required frontend files missing<br>';
            }

            const foundOptional = results.filter(r => r.includes('‚úÖ')).length;
            const totalOptional = results.filter(r => r.includes('‚ÑπÔ∏è')).length;
            summary += `‚ÑπÔ∏è ${foundOptional} files found, ${totalOptional} optional files not present<br><br>`;

            showResult('fileCheckResult', summary + results.join('<br>'), resultClass);
        }

        function checkCDNResources() {
            showResult('cdnResult', 'Checking CDN resources...', 'info');

            // Check all CDN resources that should be loaded (same as main site)
            const checks = {
                'jQuery': typeof $ !== 'undefined',
                'Bootstrap CSS': !!$('link[href*="bootstrap"]').length,
                'Bootstrap JS': typeof bootstrap !== 'undefined',
                'Font Awesome': !!$('link[href*="font-awesome"]').length,
                'Tesseract.js': typeof Tesseract !== 'undefined',
                'Custom CSS (style.css)': !!$('link[href*="style.css"]').length
            };

            let results = [];
            let loadedCount = 0;
            let totalCount = Object.keys(checks).length;

            // Check each resource
            for (const [name, loaded] of Object.entries(checks)) {
                if (loaded) {
                    results.push(`‚úÖ ${name} - Loaded successfully`);
                    loadedCount++;
                } else {
                    results.push(`‚ùå ${name} - Failed to load`);
                }
            }

            // Add summary
            const summary = `<strong>CDN Resource Summary:</strong> ${loadedCount}/${totalCount} resources loaded<br><br>`;

            // Determine result class
            const hasErrors = loadedCount < totalCount;
            const resultClass = hasErrors ? 'error' : 'success';

            showResult('cdnResult', summary + results.join('<br>'), resultClass);
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Auto-run basic checks on page load
        $(document).ready(function() {
            setTimeout(() => {
                checkCDNResources();
            }, 1000);
        });
    </script>
</body>
</html>
